# Push & Live Notifications Integration Guide (Mobile Web App)

This document provides instructions for Front-End developers to integrate real-time notifications (Live) and background push notifications (FCM) into the Foodly Mobile Web Application.

---

## 1. Push Notifications (FCM)

Foodly uses Firebase Cloud Messaging (FCM) for background notifications. The configuration is dynamic and should be fetched from the API.

### Workflow
1. **Fetch Config**: Get Firebase credentials and VAPID key from the server.
2. **Initialize**: Initialize Firebase SDK with fetched credentials.
3. **Service Worker**: Register the FCM Service Worker.
4. **Get Token**: Request notification permission and obtain the FCM registration token.
5. **Save Token**: Sync the token with the authenticated user profile.

### Step 1: Fetch Push Configuration
**Endpoint:** `GET /api/website/settings/notifications?platform=react-web`  
**Authentication:** Not Required (Public)

**Note:** The `platform=react-web` parameter is mandatory to receive the correct credentials for the React application.

This endpoint returns:
- `vapid_public_key`: Used for browser-level notification permissions.
- `firebase_config`: Standard object for `initializeApp()`.
- `notification_icon`: Default icon for notifications.

### Step 2: Register Service Worker
The service worker is dynamically generated by the backend to ensure it always has the correct Firebase credentials.
**URL:** `https://api.foodly.pro/firebase-messaging-sw.js?platform=react-web`

```javascript
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/firebase-messaging-sw.js?platform=react-web')
        .then((registration) => {
            console.log('Service Worker registered with scope:', registration.scope);
        });
}
```

### Step 3: Sync FCM Token to Backend
Once you have the registration token from `getToken(messaging, { vapidKey })`, send it to the server.

**Endpoint:** `POST /api/website/me/notifications/fcm-token`  
**Authentication:** Required (Bearer Token)

**Payload:**
```json
{
    "token": "YOUR_FCM_TOKEN_HERE",
    "platform": "web",
    "device_name": "Chrome / Android",
    "device_id": "optional-unique-uuid"
}
```

---

## 2. In-App Notifications (Live)

In-app notifications are stored in the database. Since we are **not using Laravel Echo/WebSockets**, real-time updates are handled via FCM foreground messages or polling.

### Step 1: Fetch Notification List
To display the notification history or populate the "Bell" dropdown:

**Endpoint:** `GET /api/website/me/notifications`  
**Authentication:** Required

**Response Structure:**
```json
{
    "data": [
        {
            "id": "uuid",
            "type": "ReservationLiveNotification",
            "title": "Notification Title",
            "message": "Full notification message...",
            "reservation_id": 123,
            "read_at": "2024-01-13T...",
            "created_at": "2024-01-13T...",
            "payload": {
                "title": "...",
                "message": "...",
                "image_url": "https://...",
                "reservation_id": 123,
                "display_id": "FLD-123",
                "event": "confirmed"
            }
        }
    ]
}
```

**Key Notes on Data:**
- **Translations:** The `title` and `message` are automatically translated (KA/EN) based on the user's preferred language in their profile.
- **Payload:** The `payload` object contains all the raw data, including the `image_url` for logos/icons.

### Step 2: Mark as Read
When a user clicks/views a notification:

**Single:** `POST /api/website/me/notifications/{id}/read`  
**Bulk:** `POST /api/website/me/notifications/read-all`

### Step 3: Achieving "Real-Time" without Echo
Since `BROADCAST_CONNECTION` is disabled, the app should use **FCM Foreground Messages** to detect new notifications while the user is using the app.

**Logic:**
1. When the app is in the foreground, Firebase's `onMessage` listener will trigger.
2. The payload will contain the notification data.
3. The Front-End should:
    - Show an in-app toast/banner.
    - Increment the notification bell count.
    - (Optionally) Re-fetch the notification list from the API.

**Example (FCM Foreground Listener):**
```javascript
import { getMessaging, onMessage } from "firebase/messaging";

const messaging = getMessaging();
onMessage(messaging, (payload) => {
  console.log('Message received in foreground: ', payload);
  
  // 1. Show a custom UI toast
  showToast(payload.notification.title, payload.notification.body);
  
  // 2. Update notification state/count in your app
  notificationStore.incrementUnread();
});
```

### Step 4: Fallback Polling (Optional)
As a backup, you can poll the notification count every 60-120 seconds:
`GET /api/website/me/notifications?unread_only=1`

---

## 3. Best Practices
1. **Token Refresh**: Sync the FCM token every time the app initializes.
2. **Foreground vs Background**: 
   - **Background**: Handled by Service Worker (shows OS notification).
   - **Foreground**: Handled by `onMessage` (you must show your own UI).
3. **Optimistic Updates**: Update the unread count in UI immediately after the user clicks "Mark as read".

---
**API Base URL:** `https://api.foodly.pro/api/website`
